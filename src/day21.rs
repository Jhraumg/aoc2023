use fxhash::FxHashSet;
use itertools::Itertools;
use num::Integer;
use std::collections::HashSet;
use std::str::FromStr;

#[derive(Debug)]
struct Garden {
    rocks: HashSet<(usize, usize)>,
    maxx: usize,
    maxy: usize,
    start: (usize, usize),
}
impl FromStr for Garden {
    type Err = ();

    fn from_str(s: &str) -> Result<Self, Self::Err> {
        let rocks: HashSet<_> = s
            .lines()
            .filter(|l| !l.is_empty())
            .enumerate()
            .flat_map(|(j, l)| {
                l.trim()
                    .chars()
                    .enumerate()
                    .filter_map(move |(i, c)| if c == '#' { Some((i, j)) } else { None })
            })
            .collect();
        let start = s
            .lines()
            .filter(|l| !l.is_empty())
            .enumerate()
            .flat_map(|(j, l)| {
                l.trim()
                    .chars()
                    .enumerate()
                    .filter_map(move |(i, c)| if c == 'S' { Some((i, j)) } else { None })
            })
            .next()
            .unwrap();
        let maxx = s.lines().filter(|l| !l.is_empty()).map(|l| l.trim().len()).max().unwrap();
        let maxy = s.lines().filter(|l| !l.is_empty()).count();
        assert_eq!(maxx, maxy);
        Ok(Self {
            rocks,
            maxx,
            maxy,
            start,
        })
    }
}

impl Garden {
    fn to_relative(&self, pos: (isize, isize)) -> (isize, isize) {
        let (x, y) = pos;
        (x - self.start.0 as isize, y - self.start.1 as isize)
    }
    fn to_absolute(&self, pos: (isize, isize)) -> (isize, isize) {
        let (x, y) = pos;
        (x + self.start.0 as isize, y + self.start.1 as isize)
    }

    fn step(&self, pos: (usize, usize)) -> Vec<(usize, usize)> {
        let (x, y) = pos;
        let west = if x > 0 { Some((x - 1, y)) } else { None };
        let north = if y > 0 { Some((x, y - 1)) } else { None };
        let east = if x + 1 < self.maxx {
            Some((x + 1, y))
        } else {
            None
        };
        let south = if y + 1 < self.maxy {
            Some((x, y + 1))
        } else {
            None
        };
        [north, west, south, east]
            .into_iter()
            .flatten()
            .filter(|(x, y)| !self.rocks.contains(&(*x, *y)))
            .collect()
    }
    fn naive_pos_after_n_steps(&self, n: usize) -> usize {
        let mut cur_pos: Vec<(usize, usize)> = vec![self.start];
        for _ in 0..n {
            cur_pos = cur_pos
                .into_iter()
                .flat_map(|p| self.step(p).into_iter())
                .filter(|(x, y)| !self.rocks.contains(&(*x, *y)))
                .unique()
                .collect();
        }
        for y in 0..self.maxy {
            println!(
                "{}",
                (0..self.maxx)
                    .map(|x| if self.rocks.contains(&(x, y)) {
                        "#"
                    } else if cur_pos.contains(&(x, y)) {
                        "O"
                    } else {
                        "."
                    })
                    .join("")
            );
        }
        cur_pos.len()
    }
    fn istep(&self, pos: (isize, isize)) -> [(isize, isize); 4] {
        let (x, y) = pos;
        [(x, y - 1), (x - 1, y), (x, y + 1), (x + 1, y)]
    }

    fn count_reachable_after_n_steps(&self, n: usize) -> usize {
        let mut not_reached: FxHashSet<(isize, isize)> = Default::default();
        let mut previous_not_reached: FxHashSet<(isize, isize)> = Default::default();

        previous_not_reached.insert((self.start.0 as isize, self.start.1 as isize));
        let maxx = self.maxx as isize;
        let maxy = self.maxy as isize;

        for i in 1..=n {
            // FIXME : dont store all points
            let i = i as isize;
            let new_points: FxHashSet<_> = (0..=i)
                .flat_map(|k| {
                    let k = k as isize;
                    [(k, i - k), (k, k - i), (-k, i - k), (-k, k - i)]
                        .into_iter()
                        .map(|(x, y)| (x + self.start.0 as isize, y + self.start.1 as isize))
                        .unique()
                })
                .collect();
            // println!("\n{i:2} new points {new_points:?}");
            let new_not_reached_from_rocks: FxHashSet<_> = new_points
                .iter()
                .filter(|(i, j)| {
                    self.rocks.contains(&(
                        ((maxx + (i % maxx)) % maxx) as usize,
                        ((maxy + (j % maxy)) % maxy) as usize,
                    ))
                })
                .copied()
                .collect();
            // println!("new rocks {new_not_reached_from_rocks:?}");
            let occulted: FxHashSet<_> = new_points
                .iter()
                .filter(|(x, y)| {
                    [(*x + 1, *y), (*x - 1, *y), (*x, *y + 1), (*x, *y - 1)].into_iter().all(|p| {
                        let (x, y) = self.to_relative(p);
                        x.abs() + y.abs() >= i  || not_reached.contains(&p)
                    })
                })
                .copied()
                .collect();
            // println!("{i:2} occulted {occulted:?}");

            let newly_reached: FxHashSet<_> = previous_not_reached
                .iter()
                .filter(|(x, y)| !self.rocks.contains(&(
                    ((maxx + (*x % maxx)) % maxx) as usize,
                    ((maxy + (*y % maxy)) % maxy) as usize,
                )) &&
                    [(*x + 1, *y), (*x - 1, *y), (*x, *y + 1), (*x, *y - 1)]
                        .into_iter()
                        .any(|(x, y)| !not_reached.contains(&(x, y)))
                )
                .copied()
                .collect();
            // println!("{i:2} newly_reached {newly_reached:?}");

            let save = not_reached.clone();
            not_reached = new_not_reached_from_rocks
                .union(&occulted)
                .chain(previous_not_reached.iter())
                .filter(|nr| !newly_reached.contains(*nr))
                .copied()
                .collect();
            previous_not_reached = save;
            // println!("{i:2} => not_reached {not_reached:?}");
        }

        println!("for {n}, not _reached is {} long", not_reached.len());

        (n + 1) * (n + 1) - not_reached.len()
    }

    fn infinite_pos_after_n_steps(&self, n: usize) -> usize {
        /// if there was no rocks, then, the maping would be
        /// 0:
        /// ```
        /// o
        /// ```
        /// 1:
        ///```
        ///  o
        /// o o
        ///  o
        ///```
        /// 2:
        ///```
        ///  o
        /// o o
        ///o o o
        /// o o
        ///  o
        ///```
        /// (n+1)Â² (a square of len n+1)
        ///
        /// starting from (0,0), a point p(i,j) would be  reached at i+j and would be lit at each n >= i+j, n%2 == (i+j)%2
        /// ~~we just need to adjust for~~
        /// - ~~the rocks which are always off~~ **no, they also make the path to other point longer !**
        /// - the start (but we always start in the middle of the garden
        // FIXME We can compute distance to S with a simple loop
        let start_to_rocks: Vec<usize> = self
            .rocks
            .iter()
            .map(|(x, y)| x.abs_diff(self.start.0) + y.abs_diff(self.start.1))
            .collect();
        let period = self.maxx as isize;
        let nisize = n as isize;
        let m = 1 + nisize / period;

        let rocks_on = (-m..=m)
            .flat_map(|j| (-m..=m).map(move |i| (i + j) * period))
            .map(|full_d| {
                start_to_rocks
                    .iter()
                    .filter(move |d| (**d as isize + full_d).abs() <= nisize)
                    .map(move |d| (*d as isize + full_d) % 2 == nisize % 2)
            })
            .count();
        (n + 1) * (n + 1) - 4 * dbg!(rocks_on)
    }
}
pub fn walk_exercise() {
    let garden: Garden = include_str!("../resources/day21_garden.txt").parse().unwrap();
    let max_pos = garden.naive_pos_after_n_steps(64);
    println!("pos after 64 steps : {max_pos}");
    let max_pos = garden.naive_pos_after_n_steps(26501365);
    println!("pos after 26501365 steps : {max_pos}");
}
#[cfg(test)]
mod tests {
    use super::*;
    use indoc::indoc;
    #[test]
    fn aoc_example_works() {
        let garden: Garden = indoc! {"
            ...........
            .....###.#.
            .###.##..#.
            ..#.#...#..
            ....#.#....
            .##..S####.
            .##..#...#.
            .......##..
            .##.#.####.
            .##..##.##.
            ...........
        "}
        .parse()
        .unwrap();

        // assert_eq!(16, garden.naive_pos_after_n_steps(6));
        // assert_eq!(2, garden.count_reachable_after_n_steps(1));
        // assert_eq!(4, garden.count_reachable_after_n_steps(2));
        assert_eq!(6, garden.count_reachable_after_n_steps(3));

        assert_eq!(16, garden.count_reachable_after_n_steps(6));
        assert_eq!(50, garden.count_reachable_after_n_steps(10));
        assert_eq!(167004, garden.count_reachable_after_n_steps(500));
        assert_eq!(668697, garden.count_reachable_after_n_steps(1000));
        assert_eq!(16733044, garden.count_reachable_after_n_steps(5000));

        //
        //
        // let garden: Garden = indoc! {"
        //     ..............................................................................................................
        //     .....###.#......###.#......###.#......###.#......###.#......###.#......###.#......###.#......###.#......###.#.
        //     .###.##..#..###.##..#..###.##..#..###.##..#..###.##..#..###.##..#..###.##..#..###.##..#..###.##..#..###.##..#.
        //     ..#.#...#....#.#...#....#.#...#....#.#...#....#.#...#....#.#...#....#.#...#....#.#...#....#.#...#....#.#...#..
        //     ....#.#........#.#........#.#........#.#........#.#........#.#........#.#........#.#........#.#........#.#....
        //     .##...####..##...####..##...####..##...####..##...####..##...####..##...####..##...####..##...####..##...####.
        //     .##..#...#..##..#...#..##..#...#..##..#...#..##..#...#..##..#...#..##..#...#..##..#...#..##..#...#..##..#...#.
        //     .......##.........##.........##.........##.........##.........##.........##.........##.........##.........##..
        //     .##.#.####..##.#.####..##.#.####..##.#.####..##.#.####..##.#.####..##.#.####..##.#.####..##.#.####..##.#.####.
        //     .##..##.##..##..##.##..##..##.##..##..##.##..##..##.##..##..##.##..##..##.##..##..##.##..##..##.##..##..##.##.
        //     ..............................................................................................................
        //     ..............................................................................................................
        //     .....###.#......###.#......###.#......###.#......###.#......###.#......###.#......###.#......###.#......###.#.
        //     .###.##..#..###.##..#..###.##..#..###.##..#..###.##..#..###.##..#..###.##..#..###.##..#..###.##..#..###.##..#.
        //     ..#.#...#....#.#...#....#.#...#....#.#...#....#.#...#....#.#...#....#.#...#....#.#...#....#.#...#....#.#...#..
        //     ....#.#........#.#........#.#........#.#........#.#........#.#........#.#........#.#........#.#........#.#....
        //     .##...####..##...####..##...####..##...####..##...####..##...####..##...####..##...####..##...####..##...####.
        //     .##..#...#..##..#...#..##..#...#..##..#...#..##..#...#..##..#...#..##..#...#..##..#...#..##..#...#..##..#...#.
        //     .......##.........##.........##.........##.........##.........##.........##.........##.........##.........##..
        //     .##.#.####..##.#.####..##.#.####..##.#.####..##.#.####..##.#.####..##.#.####..##.#.####..##.#.####..##.#.####.
        //     .##..##.##..##..##.##..##..##.##..##..##.##..##..##.##..##..##.##..##..##.##..##..##.##..##..##.##..##..##.##.
        //     ..............................................................................................................
        //     ..............................................................................................................
        //     .....###.#......###.#......###.#......###.#......###.#......###.#......###.#......###.#......###.#......###.#.
        //     .###.##..#..###.##..#..###.##..#..###.##..#..###.##..#..###.##..#..###.##..#..###.##..#..###.##..#..###.##..#.
        //     ..#.#...#....#.#...#....#.#...#....#.#...#....#.#...#....#.#...#....#.#...#....#.#...#....#.#...#....#.#...#..
        //     ....#.#........#.#........#.#........#.#........#.#........#.#........#.#........#.#........#.#........#.#....
        //     .##...####..##...####..##...####..##...####..##...####..##...####..##...####..##...####..##...####..##...####.
        //     .##..#...#..##..#...#..##..#...#..##..#...#..##..#...#..##..#...#..##..#...#..##..#...#..##..#...#..##..#...#.
        //     .......##.........##.........##.........##.........##.........##.........##.........##.........##.........##..
        //     .##.#.####..##.#.####..##.#.####..##.#.####..##.#.####..##.#.####..##.#.####..##.#.####..##.#.####..##.#.####.
        //     .##..##.##..##..##.##..##..##.##..##..##.##..##..##.##..##..##.##..##..##.##..##..##.##..##..##.##..##..##.##.
        //     ..............................................................................................................
        //     ..............................................................................................................
        //     .....###.#......###.#......###.#......###.#......###.#......###.#......###.#......###.#......###.#......###.#.
        //     .###.##..#..###.##..#..###.##..#..###.##..#..###.##..#..###.##..#..###.##..#..###.##..#..###.##..#..###.##..#.
        //     ..#.#...#....#.#...#....#.#...#....#.#...#....#.#...#....#.#...#....#.#...#....#.#...#....#.#...#....#.#...#..
        //     ....#.#........#.#........#.#........#.#........#.#........#.#........#.#........#.#........#.#........#.#....
        //     .##...####..##...####..##...####..##...####..##...####..##...####..##...####..##...####..##...####..##...####.
        //     .##..#...#..##..#...#..##..#...#..##..#...#..##..#...#..##..#...#..##..#...#..##..#...#..##..#...#..##..#...#.
        //     .......##.........##.........##.........##.........##.........##.........##.........##.........##.........##..
        //     .##.#.####..##.#.####..##.#.####..##.#.####..##.#.####..##.#.####..##.#.####..##.#.####..##.#.####..##.#.####.
        //     .##..##.##..##..##.##..##..##.##..##..##.##..##..##.##..##..##.##..##..##.##..##..##.##..##..##.##..##..##.##.
        //     ..............................................................................................................
        //     ..............................................................................................................
        //     .....###.#......###.#......###.#......###.#......###.#......###.#......###.#......###.#......###.#......###.#.
        //     .###.##..#..###.##..#..###.##..#..###.##..#..###.##..#..###.##..#..###.##..#..###.##..#..###.##..#..###.##..#.
        //     ..#.#...#....#.#...#....#.#...#....#.#...#....#.#...#....#.#...#....#.#...#....#.#...#....#.#...#....#.#...#..
        //     ....#.#........#.#........#.#........#.#........#.#........#.#........#.#........#.#........#.#........#.#....
        //     .##...####..##...####..##...####..##...####..##...####..##..S####..##...####..##...####..##...####..##...####.
        //     .##..#...#..##..#...#..##..#...#..##..#...#..##..#...#..##..#...#..##..#...#..##..#...#..##..#...#..##..#...#.
        //     .......##.........##.........##.........##.........##.........##.........##.........##.........##.........##..
        //     .##.#.####..##.#.####..##.#.####..##.#.####..##.#.####..##.#.####..##.#.####..##.#.####..##.#.####..##.#.####.
        //     .##..##.##..##..##.##..##..##.##..##..##.##..##..##.##..##..##.##..##..##.##..##..##.##..##..##.##..##..##.##.
        //     ..............................................................................................................
        //     ..............................................................................................................
        //     .....###.#......###.#......###.#......###.#......###.#......###.#......###.#......###.#......###.#......###.#.
        //     .###.##..#..###.##..#..###.##..#..###.##..#..###.##..#..###.##..#..###.##..#..###.##..#..###.##..#..###.##..#.
        //     ..#.#...#....#.#...#....#.#...#....#.#...#....#.#...#....#.#...#....#.#...#....#.#...#....#.#...#....#.#...#..
        //     ....#.#........#.#........#.#........#.#........#.#........#.#........#.#........#.#........#.#........#.#....
        //     .##...####..##...####..##...####..##...####..##...####..##...####..##...####..##...####..##...####..##...####.
        //     .##..#...#..##..#...#..##..#...#..##..#...#..##..#...#..##..#...#..##..#...#..##..#...#..##..#...#..##..#...#.
        //     .......##.........##.........##.........##.........##.........##.........##.........##.........##.........##..
        //     .##.#.####..##.#.####..##.#.####..##.#.####..##.#.####..##.#.####..##.#.####..##.#.####..##.#.####..##.#.####.
        //     .##..##.##..##..##.##..##..##.##..##..##.##..##..##.##..##..##.##..##..##.##..##..##.##..##..##.##..##..##.##.
        //     ..............................................................................................................
        //     ..............................................................................................................
        //     .....###.#......###.#......###.#......###.#......###.#......###.#......###.#......###.#......###.#......###.#.
        //     .###.##..#..###.##..#..###.##..#..###.##..#..###.##..#..###.##..#..###.##..#..###.##..#..###.##..#..###.##..#.
        //     ..#.#...#....#.#...#....#.#...#....#.#...#....#.#...#....#.#...#....#.#...#....#.#...#....#.#...#....#.#...#..
        //     ....#.#........#.#........#.#........#.#........#.#........#.#........#.#........#.#........#.#........#.#....
        //     .##...####..##...####..##...####..##...####..##...####..##...####..##...####..##...####..##...####..##...####.
        //     .##..#...#..##..#...#..##..#...#..##..#...#..##..#...#..##..#...#..##..#...#..##..#...#..##..#...#..##..#...#.
        //     .......##.........##.........##.........##.........##.........##.........##.........##.........##.........##..
        //     .##.#.####..##.#.####..##.#.####..##.#.####..##.#.####..##.#.####..##.#.####..##.#.####..##.#.####..##.#.####.
        //     .##..##.##..##..##.##..##..##.##..##..##.##..##..##.##..##..##.##..##..##.##..##..##.##..##..##.##..##..##.##.
        //     ..............................................................................................................
        //     ..............................................................................................................
        //     .....###.#......###.#......###.#......###.#......###.#......###.#......###.#......###.#......###.#......###.#.
        //     .###.##..#..###.##..#..###.##..#..###.##..#..###.##..#..###.##..#..###.##..#..###.##..#..###.##..#..###.##..#.
        //     ..#.#...#....#.#...#....#.#...#....#.#...#....#.#...#....#.#...#....#.#...#....#.#...#....#.#...#....#.#...#..
        //     ....#.#........#.#........#.#........#.#........#.#........#.#........#.#........#.#........#.#........#.#....
        //     .##...####..##...####..##...####..##...####..##...####..##...####..##...####..##...####..##...####..##...####.
        //     .##..#...#..##..#...#..##..#...#..##..#...#..##..#...#..##..#...#..##..#...#..##..#...#..##..#...#..##..#...#.
        //     .......##.........##.........##.........##.........##.........##.........##.........##.........##.........##..
        //     .##.#.####..##.#.####..##.#.####..##.#.####..##.#.####..##.#.####..##.#.####..##.#.####..##.#.####..##.#.####.
        //     .##..##.##..##..##.##..##..##.##..##..##.##..##..##.##..##..##.##..##..##.##..##..##.##..##..##.##..##..##.##.
        //     ..............................................................................................................
        //     ..............................................................................................................
        //     .....###.#......###.#......###.#......###.#......###.#......###.#......###.#......###.#......###.#......###.#.
        //     .###.##..#..###.##..#..###.##..#..###.##..#..###.##..#..###.##..#..###.##..#..###.##..#..###.##..#..###.##..#.
        //     ..#.#...#....#.#...#....#.#...#....#.#...#....#.#...#....#.#...#....#.#...#....#.#...#....#.#...#....#.#...#..
        //     ....#.#........#.#........#.#........#.#........#.#........#.#........#.#........#.#........#.#........#.#....
        //     .##...####..##...####..##...####..##...####..##...####..##...####..##...####..##...####..##...####..##...####.
        //     .##..#...#..##..#...#..##..#...#..##..#...#..##..#...#..##..#...#..##..#...#..##..#...#..##..#...#..##..#...#.
        //     .......##.........##.........##.........##.........##.........##.........##.........##.........##.........##..
        //     .##.#.####..##.#.####..##.#.####..##.#.####..##.#.####..##.#.####..##.#.####..##.#.####..##.#.####..##.#.####.
        //     .##..##.##..##..##.##..##..##.##..##..##.##..##..##.##..##..##.##..##..##.##..##..##.##..##..##.##..##..##.##.
        //     ..............................................................................................................
        // "}
        //     .parse()
        //     .unwrap();
        // // assert_eq!(50, garden.naive_pos_after_n_steps(10));
        // assert_eq!(1594, garden.naive_pos_after_n_steps(50));
    }
}
// 7154 too high
